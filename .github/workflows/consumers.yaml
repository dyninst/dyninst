name: Build Consumers

on:
  schedule:
    - cron: '0 3 * * 1' # Monday at 3AM
  workflow_dispatch:

jobs:

  get-oses:
    runs-on: ubuntu-latest
    outputs:
      latest: ${{ steps.all.outputs.latest }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - id: all
        uses: ./.github/actions/os-versions

  get-compilers:
    runs-on: ubuntu-latest
    outputs:
      all: ${{ steps.compilers.outputs.value }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - id: compilers
        shell: bash
        run: |
          set -ex
          script="./.github/scripts/compiler_configs.py"
          names=$(python3 ${script} --print-names)
          echo "value=${names}" >> $GITHUB_OUTPUT


  hpctoolkit:
    runs-on: ubuntu-latest
    needs: [get-oses, get-compilers]
    strategy:
      fail-fast: false
      matrix:
         os: ${{ fromJson(needs.get-oses.outputs.latest) }}
         compiler: ${{ fromJson(needs.get-compilers.outputs.all) }}
    permissions:
      packages: read
    container:
      image: ghcr.io/dyninst/amd64/${{ matrix.os }}:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.github_token }}
    name: HPCToolkit (${{ matrix.os }}, ${{ matrix.compiler }})
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          path: "src"  # relative to $GITHUB_WORKSPACE

      - name: Install dependencies (Ubuntu)
        if: ${{ startsWith(matrix.os, 'ubuntu') }}
        shell: bash
        run: |
          set -ex
          apt update -qq
          apt install -y -qq gfortran m4 autoconf python3 python3-venv unzip meson ninja-build pkgconf \
                             libxerces-c-dev libyaml-cpp-dev libpfm4-dev libunwind-dev libxxhash-dev \
                             libboost-chrono-dev libboost-graph-dev libboost-regex-dev
          
      - name: Install dependencies (Fedora)
        if: ${{ startsWith(matrix.os, 'fedora') }}
        shell: bash
        run: |
          set -ex
          yum install -y gcc-gfortran m4 autoconf python3 unzip meson ninja-build pkgconf xerces-c-devel \
                         yaml-cpp-devel libunwind-devel xxhash-devel boost-chrono boost-graph boost-regex xz \
                         lbzip2

      - name: Install spack
        shell: bash
        run: |
          set -ex
          git clone --depth=1 --branch=develop https://github.com/spack/spack
          spack/bin/spack compiler find

      - name: Install spack externals
        shell: bash
        run: |
          set -ex
          spack/bin/spack external find --not-buildable cmake git m4 gmake meson ninja pkgconf curl python

      - name: Install spack externals (Ubuntu)
        if: ${{ startsWith(matrix.os, 'ubuntu') }}
        shell: bash
        run: |
          set -ex
          add="${GITHUB_WORKSPACE}/src/.github/scripts/add_spack_package.py"
          python3 ${add} $HOME/.spack --lib intel-tbb --version 2021.11.0 --location /usr
          python3 ${add} $HOME/.spack --lib elfutils --version 0.191 --location /usr
          python3 ${add} $HOME/.spack --lib dyninst --version master --location /dyninst/install
          python3 ${add} $HOME/.spack --lib boost --version 1.83.0 --location /usr
          python3 ${add} $HOME/.spack --lib xerces-c --version 3.2.4 --location /usr
          python3 ${add} $HOME/.spack --lib yaml-cpp --version 0.8.0 --location /usr
          python3 ${add} $HOME/.spack --lib libpfm4 --version 4.13.0 --location /usr
          python3 ${add} $HOME/.spack --lib libunwind --version 1.6.2 --location /usr
          python3 ${add} $HOME/.spack --lib xxhash --version 0.8.2 --location /usr

      - name: Install spack externals (Fedora)
        if: ${{ startsWith(matrix.os, 'fedora') }}
        shell: bash
        run: |
          set -ex
          add="${GITHUB_WORKSPACE}/src/.github/scripts/add_spack_package.py"
          python3 ${add} $HOME/.spack --lib intel-tbb --version 2020.3 --location /usr
          python3 ${add} $HOME/.spack --lib elfutils --version 0.190 --location /usr
          python3 ${add} $HOME/.spack --lib dyninst --version master --location /dyninst/install
          python3 ${add} $HOME/.spack --lib boost --version 1.81.0 --location /usr
          python3 ${add} $HOME/.spack --lib xerces-c --version 3.2.5 --location /usr
          python3 ${add} $HOME/.spack --lib yaml-cpp --version 0.7.0 --location /usr
          python3 ${add} $HOME/.spack --lib libunwind --version 1.7.0 --location /usr
          python3 ${add} $HOME/.spack --lib xxhash --version 0.8.2 --location /usr

      - name: Build
        shell: bash
        run: |
          set -ex
          spack/bin/spack install -j2 hpctoolkit@develop~viewer~papi ^intel-tbb ^dyninst@master %${{ matrix.compiler }}
