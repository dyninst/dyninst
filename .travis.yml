language: cpp

sudo: false

env:
    global:
        - LLVM_VERSION=3.7.0
        - LD_LIBRARY_PATH=$HOME/clang-$LLVM_VERSION/lib:/usr/lib/x86_64-linux-gnu/:$LD_LIBRARY_PATH

addons:
    apt:
        sources:
            - kubuntu-backports
            - ubuntu-toolchain-r-test
            - boost-latest
        packages:
            - binutils-dev
            - libboost-system1.55-dev
            - libboost-thread1.55-dev
            - cmake
            - elfutils
            - libelf1
            - libelf-dev
            - g++-4.9

env:
    global:
        - DYNINSTAPI_RT_LIB=$HOME/install/lib/libdyninstAPI_RT.so
        - DYNINST_DEBUG_STARTUP=1
        - PATH=$PATH:$HOME/install/bin

compiler:
    - gcc
    - clang

cache:
    directories:
        - $HOME/llvm-3.7.0

before_install:
    - if [ ! -d $HOME/llvm-$LLVM_VERSION/bin ]; then
        wget -O llvm-$LLVM_VERSION.tar.xz http://llvm.org/releases/$LLVM_VERSION/clang+llvm-$LLVM_VERSION-x86_64-linux-gnu-ubuntu-14.04.tar.xz;
        tar xf llvm-$LLVM_VERSION.tar.xz --strip 1 -C $HOME/llvm-$LLVM_VERSION;
      fi

before_script:
    - git clone --depth 1 git://github.com/dyninst/testsuite

script:
    - if [ "$CC" == "clang" ]; then export CC=$HOME/llvm-$LLVM_VERSION/bin/clang; export CXX=$HOME/llvm-$LLVM_VERSION/bin/clang++; fi
    - if [ "$CC" == "gcc" ]; then export CC=gcc-4.9; export CXX=g++-4.9; fi
    - find /usr -name 'libelf.*'
    - mkdir work
    - cd work
    - cmake .. -DCMAKE_INSTALL_PREFIX=$HOME/install
    - make -j2
    - make install
    - cd ../testsuite
    - mkdir work
    - cd work
    - cmake .. -DDyninst_DIR=$HOME/install/lib/cmake/Dyninst -DCMAKE_INSTALL_PREFIX=$HOME/install
    - make -j2
    - make install
    - $HOME/install/bin/testsuite/runTests -all -log -verbose
